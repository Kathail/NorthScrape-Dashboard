<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NorthScrape Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' } } } }
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-950 text-slate-800 dark:text-slate-100 min-h-screen font-sans p-6">

    <div class="max-w-4xl mx-auto">
        <div class="flex items-center gap-3 mb-8">
            <i data-lucide="candycane" class="h-8 w-8 text-pink-400"></i>
            <h1 class="font-bold text-3xl tracking-tight">NorthScrape Generator</h1>
        </div>

        <div class="bg-white dark:bg-slate-900 rounded-xl shadow-lg border dark:border-slate-800 p-6">
            <div class="grid md:grid-cols-2 gap-8">
                
                <div>
                    <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="briefcase" class="w-5 h-5 text-blue-500"></i> Business Types
                    </h2>
                    <div class="h-64 overflow-y-auto border dark:border-slate-700 rounded-lg p-2 bg-slate-50 dark:bg-slate-950">
                        {% for cat in categories %}
                        <label class="flex items-center gap-3 p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded cursor-pointer">
                            <input type="checkbox" value="{{ cat }}" class="cat-check w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm">{{ cat }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="toggleAll('cat-check', true)" class="text-xs text-blue-500 hover:underline">Select All</button>
                        <button onclick="toggleAll('cat-check', false)" class="text-xs text-slate-500 hover:underline">Clear</button>
                    </div>
                </div>

                <div>
                    <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-5 h-5 text-green-500"></i> Locations
                    </h2>
                    <div class="h-64 overflow-y-auto border dark:border-slate-700 rounded-lg p-2 bg-slate-50 dark:bg-slate-950">
                        {% for loc in locations %}
                        <label class="flex items-center gap-3 p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded cursor-pointer">
                            <input type="checkbox" value="{{ loc }}" class="loc-check w-4 h-4 text-green-600 rounded">
                            <span class="text-sm">{{ loc }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="toggleAll('loc-check', true)" class="text-xs text-blue-500 hover:underline">Select All</button>
                        <button onclick="toggleAll('loc-check', false)" class="text-xs text-slate-500 hover:underline">Clear</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t dark:border-slate-800">
                <div id="status-area" class="hidden mb-4 p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-200 flex items-center gap-3">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-current"></div>
                    <span id="status-text">Scraping and Enriching... this may take a minute...</span>
                </div>

                <button id="btn-start" onclick="startScrape()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i data-lucide="rocket" class="w-6 h-6"></i> Start Generation
                </button>
                
                <div class="mt-4 text-center">
                     <a href="/northscrape/dashboard" class="text-sm text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Skip to Dashboard &rarr;</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        function toggleAll(cls, state) {
            document.querySelectorAll('.' + cls).forEach(c => c.checked = state);
        }

        async function startScrape() {
            const cats = Array.from(document.querySelectorAll('.cat-check:checked')).map(c => c.value);
            const locs = Array.from(document.querySelectorAll('.loc-check:checked')).map(c => c.value);

            if (cats.length === 0 || locs.length === 0) {
                alert("Please select at least one Category and one Location.");
                return;
            }

            const btn = document.getElementById('btn-start');
            const status = document.getElementById('status-area');
            
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            status.classList.remove('hidden');

            try {
                const response = await fetch('/northscrape/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories: cats, locations: locs })
                });

                if (!response.ok) throw new Error("Scrape failed");

                const data = await response.json();
                
                // --- CRITICAL: Bridge to Dashboard ---
                // We save the data to localStorage using the key the Dashboard expects ('northscrape_data')
                // This mimics loading a file in the previous version.
                localStorage.setItem('northscrape_data', JSON.stringify(data));
                
                document.getElementById('status-text').innerText = `Success! Found ${data.length} leads. Redirecting...`;
                
                setTimeout(() => {
                    window.location.href = '/northscrape/dashboard';
                }, 1000);

            } catch (error) {
                alert("Error: " + error.message);
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                status.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
